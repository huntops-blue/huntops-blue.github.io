I"·'<h1 id="2242020---ursnif">2/24/2020 - Ursnif</h1>
<ul>
  <li><a href="http://malware-traffic-analysis.net/2020/02/11/index.html">Packets</a></li>
  <li><a href="https://attack.mitre.org/software/S0386/">Qbot banking trojan background</a></li>
</ul>

<p>Suricata has picked up some easy things to get started on, so letâ€™s start there.</p>

<p><img src="/images/2-24-20-1.png" alt="" /></p>

<p>Of particular interest to me (not that the others arenâ€™t interesting), are the executable signatures; so letâ€™s filter out the <code class="highlighter-rouge">opendns[.]com</code> lookups for now. This takes us down to a single source and destination to focus on, <code class="highlighter-rouge">194[.]61[.]2[.]16</code> and <code class="highlighter-rouge">10.2.11.101</code>.</p>

<p><img src="/images/2-24-20-2.png" alt="" /></p>

<p>Hopping over to the Discover tab, when we apply the source IP from the previous step, we see only 8 eventsâ€¦definitely manageable. Letâ€™s get rid of the <code class="highlighter-rouge">alert</code> dataset because we know about those from the Suricata dashboard.</p>

<p><img src="/images/2-24-20-3.png" alt="" /></p>

<p>Now that weâ€™ve used the metadata to get down to a single IP address as the potential bad actor, letâ€™s use Docket to carve the packets for that IP and see what it can tell us. Using Wireshark on these packets, we follow the TCP stream and see this URL and a downloaded PE executable.</p>

<p><img src="/images/2-24-20-4.png" alt="" /></p>

<p>Exporting the HTTP object gives us the PE file, which we can analyze as well.</p>

<p><img src="/images/2-24-20-5.png" alt="" /></p>

<p>Using <code class="highlighter-rouge">exiftool</code>, we can see some interesting info, mainly that the original file was called <code class="highlighter-rouge">soldier.dll</code> and that the File Type is <code class="highlighter-rouge">Win32 EXE</code> (truncated).</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ exiftool lastimg.png
...
File Name                       : 215z9urlgz.php%3fl=xubiz8.cab
File Type                       : Win32 EXE
File Type Extension             : exe
MIME Type                       : application/octet-stream
Image File Characteristics      : Executable, 32-bit
PE Type                         : PE32
Original File Name              : soldier.dll
...
</code></pre></div></div>

<p>Checking with VirusTotal, we see that the file hash is <a href="https://www.virustotal.com/gui/file/996fcd8c55f923e86477d3d8069f9e9b56c6301cf9b2678c5c5c40bf6a636a5f/detection">known bad</a> so this looks like a good find!</p>

<p>Now that we have a few more hints to search through, specifically <code class="highlighter-rouge">qr12s8ygy1[.]com</code>, letâ€™s go back to Kibana and remove the stuff weâ€™ve already found and see if we can find anything else.</p>

<p><em>Of note, <code class="highlighter-rouge">settings-win.data.microsoft.com</code> appears to be a Microsoft botnet sinkhole, so while we can use some of the info, Iâ€™m going to remove this from our searches to eliminate traffic routes to chase. Additionally, Iâ€™m filtering out the OpenDNS traffic.</em></p>

<p>Moving along, letâ€™s make a Kibana data table to clean up our view a bit and we see <code class="highlighter-rouge">95[.]169[.]181[.]35</code> and <code class="highlighter-rouge">lcdixieeoe[.]com</code>, of note are those long URIâ€™s + an AVI file. Letâ€™s use Docket to see whatâ€™s in those packets.</p>

<p><img src="/images/2-24-20-6.png" alt="" /></p>

<p>Hopping right into Exporting the HTTP objects, we see the <code class="highlighter-rouge">*.avi</code> files we observed in Kibanaâ€™s <code class="highlighter-rouge">url.original</code> field. Letâ€™s save those and take a look.</p>

<p><img src="/images/2-24-20-7.png" alt="" /></p>

<p>In looking at the metadata for those â€œaviâ€ files, we see that theyâ€™re actually just Text files.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>======== B.avi
...
File Name                       : B.avi
File Type                       : TXT
File Type Extension             : txt
MIME Type                       : text/plain
...
======== alSLK.avi
...
File Name                       : alSLK.avi
File Type                       : TXT
File Type Extension             : txt
MIME Type                       : text/plain
...
======== jNjcj.avi
...
File Name                       : jNjcj.avi
File Type                       : TXT
File Type Extension             : txt
MIME Type                       : text/plain
...
</code></pre></div></div>

<p>I poked and prodded on these files, but Iâ€™m not sure what they areâ€¦but I know they arenâ€™t normal media files. It looks like Base64 encoding, but Iâ€™m not sure what order theyâ€™re supposed to be assembled in to decode. Either way, they have the <code class="highlighter-rouge">.avi</code> file extension and certainly arenâ€™t, so Iâ€™d put that in the suspect category.</p>

<p>Extract of <code class="highlighter-rouge">B.avi</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
p1kTy18hM3gcANzilINMVJWdUP4AbxDka8IVGBACN+HkZxzdIOi86DoUwglmVgw+BsGdGC3WLgE45BoaeDFcYxpoS8/HzXcwtxxa45Wiqordymiv5JlqzxHWS647gV2B0XpV1+A5h9PTPvxdfJV/CIAYGgCqFLzlxXF3znojgEGWHj/MwRbhIgMIKm9FDqEQEqxjDIv0SC+sqN9TxpQLNPCdqJwMTuQN2sfat464J1bh9LWzHwPwyZXErBH5+XmvEbIjOX3ptyRJOa4C+W0Cf6yOFLIPWas659a0x5tZAQs1VbwMjylWLlx6LA2Dmop1C4dwb+zH5SSJrYo5RKbc6DV1AmmRpeJ1NXkO30Z2Bq27U+h3uRUnMulPWSp1uTeLwc8LSFK49kTIaV0lwWNfDeb975aPmPac6kZP/5g5xgfB5/53/kC2KvHCbMUF8RotemD2ak+Lc0gzP7W/pcmbw/ZhxmdFJd5rPJz1lhGIOEZX6buFkcg3vjsBInd319vLO+ZSZmbU8m1ZryNsfLZ56tEvbafgCY1Jz/tP4UdKL6DZPyjCXC7oIEoCO3yn/yHOaFFQvOFizv2OnUPVW3ST+BN/TwkHUSZfE1+lKvjXJBsONeaiAa5ozLa2uI/ebx1caPFMjw0j62H23r0YFd0opsTw2ovlkvKcx3eoT
...
</code></pre></div></div>

<p>Extract of a normal .avi files</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RIFF,O
AVI LISTï¿½hdrlavih85ï¿½
                    ï¿½"ï¿½LISTtstrlstrh8vidscvidï¿½"ï¿½strf((ï¿½IV41JUNKLISTï¿½;
movi00db~
ï¿½ï¿½ï¿½|
ï¿½ï¿½`ï¿½ï¿½Øï¿½ï¿½ï¿½ï¿½@ï¿½|ï¿½ï¿½@ï¿½P!ï¿½ï¿½ï¿½ï¿½9ï¿½ï¿½ï¿½&amp;ï¿½ï¿½yï¿½ï¿½iï¿½ï¿½yï¿½ï¿½ï¿½yï¿½ï¿½y&gt;ï¿½ï¿½ï¿½ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½yï¿½ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;Ï²&lt;ï¿½ï¿½ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;Ï³ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½(ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½,ï¿½ï¿½&lt;ï¿½S&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½|ï¿½ï¿½yï¿½ï¿½y&gt;ï¿½ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½&lt;ï¿½ï¿½ï¿½ï¿½|nï¿½ï¿½yï¿½ï¿½yï¿½ï¿½ï¿½y&gt;3ï¿½ï¿½yï¿½ï¿½yï¿½ï¿½yï¿½Qm&lt;ï¿½ï¿½ ï¿½Zï¿½;dï¿½ï¿½ï¿½ï¿½ï¿½ß¢S%ï¿½ï¿½ï¿½ï¿½Tï¿½ï¿½!~nVï¿½&amp;~RVGï¿½ï¿½ï¿½(p&amp;
                                                                    ï¿½ï¿½Û¹+ï¿½ï¿½$gï¿½Eï¿½ï¿½ï¿½Vï¿½ï¿½ï¿½
ï¿½qï¿½ï¿½bï¿½Z0ï¿½ï¿½ï¿½I.Bï¿½kï¿½ï¿½ï¿½ï¿½Xï¿½+|dy:$ï¿½X1ï¿½ï¿½9ï¿½ï¿½'Ò™*ï¿½
9ï¿½1d!ï¿½ï¿½Pï¿½xï¿½ï¿½ï¿½ï¿½lï¿½y"dï¿½m'aï¿½ï¿½#Ô&amp;Z]ï¿½"ï¿½%ï¿½ï¿½ï¿½ï¿½fzÚ¬ï¿½ï¿½q"jï¿½gï¿½cï¿½Xï¿½(ï¿½pï¿½ï¿½jï¿½ï¿½xs`ï¿½&lt;Ä¹gï¿½Rï¿½$ï¿½ï¿½pYï¿½1ï¿½
(
 p6ï¿½ï¿½ï¿½ E	s	Vï¿½pÉ«ï¿½Å’ï¿½vNaGï¿½(qï¿½9ï¿½ï¿½ï¿½ï¿½ï¿½"*ï¿½ï¿½ï¿½%
                                                    
                                                     ï¿½kï¿½8mYï¿½ï¿½fï¿½."sï¿½8
                                                                    ï¿½(WLï¿½!&lt;-|=_ï¿½ï¿½ï¿½C&amp;ï¿½Äoï¿½s8ï¿½ï¿½njï¿½ï¿½T	shï¿½ï¿½YXï¿½oBï¿½Bï¿½ï¿½(Ná ±Iï¿½ï¿½ibï¿½ï¿½8ï¿½ï¿½ï¿½Y\ï¿½'1Aï¿½.ï¿½B$tÂ´pHfB&lt;ï¿½9ï¿½ï¿½ï¿½Aï¿½n5Hfï¿½Rï¿½Dï¿½ï¿½
                                                                                                                                                                      ï¿½gï¿½ï¿½9sVIï¿½ï¿½ï¿½CsF!ï¿½ï¿½ï¿½ï¿½2ï¿½ï¿½ï¿½ï¿½Sï¿½Qï¿½Eï¿½Pï¿½ï¿½5Xjï¿½txMF:ï¿½Gï¿½qï¿½Sï¿½ï¿½kï¿½0N(3q]-ï¿½ï¿½Oï¿½Jï¿½ï¿½$ï¿½ï¿½ID&gt;ï¿½ï¿½aï¿½
ï¿½ï¿½ï¿½ï¿½c'                                                      A9ï¿½ï¿½
P@X
</code></pre></div></div>

<p>Trying a bit more on these files, 2 of these â€œaviâ€ files end in <code class="highlighter-rouge">=</code> (<code class="highlighter-rouge">B.avi</code> and <code class="highlighter-rouge">jNjcj.avi</code>), so I am definitely leaning more towards Base64. The file that doesnâ€™t end in a <code class="highlighter-rouge">=</code> (<code class="highlighter-rouge">alSLK.avi</code>), I tried to append that to the top of the two files that do end in <code class="highlighter-rouge">=</code> and then run <code class="highlighter-rouge">base64 -D -i [file] -o [file]</code>, it created binary files (which seems like progress), but no luck in taking it apart. If anyone has any ideas here, feel free to reach out.</p>

<p>Malware Traffic Analysis noted another indicator that was identified through the analysis of the infected Word documents (<code class="highlighter-rouge">45[.]141[.]103[.]204</code> and <code class="highlighter-rouge">q68jaydon3t[.]com</code>), which we donâ€™t have. So while we see the traffic, it is all over TLS minus the initial DNS request so thereâ€™s not much we can do for that. The <code class="highlighter-rouge">ja3</code> nor <code class="highlighter-rouge">ja3s</code> hash was collected. Iâ€™m adding it to the artifacts below, but this would only be â€œknown badâ€ if it was found through analysis of the document.</p>

<h2 id="detection-logic">Detection Logic</h2>
<p><a href="https://github.com/huntops-blue/detection-logic/blob/master/ursnif.md">Additional analysis, modeling, and signatures (KQL and Yara)</a>.</p>

<h2 id="artifacts">Artifacts</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>194[.]61[.]2[.]16
95[.]169[.]181[.]35
45[.]141[.]103[.]204 (found by Malware Traffic Analysis)
8962cd86b47148840b6067c971ada128
7e34d6e790707bcc862fd54c0129abfa
40186e831cd2e9679ca725064d2ab0fb
2b93fcafabab58a109fcbca4377cccda
qr12s8ygy1[.]com
lcdixieeoe[.]com
q68jaydon3t[.]com (found by Malware Traffic Analysis)
xubiz8[.]cab
/khogpfyc8n/215z9urlgz[.]php
</code></pre></div></div>

<p>Until next time, cheers and happy hunting!</p>
:ET